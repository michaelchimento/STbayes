<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Getting started with STbayes ‚Ä¢ STbayes</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Getting started with STbayes">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">STbayes</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/advanced_recipes.html">Advanced recipes</a></li>
    <li><a class="dropdown-item" href="../articles/getting_started.html">Getting started with STbayes</a></li>
    <li><a class="dropdown-item" href="../articles/simulate_data_for_power_analyses.html">Simulate data for power analyses</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Getting started with STbayes</h1>
            
      

      <div class="d-none name"><code>getting_started.Rmd</code></div>
    </div>

    
    
<p>This vignette will walk you through a simple cTADA analysis pipeline
using STbayes. We will use some simulated data from a single diffusion
trial. First let‚Äôs load the package and import event and network data.
It is possible to include co-variates, but not necessary.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://michaelchimento.github.io/STbayes">STbayes</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/posterior/" class="external-link">posterior</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="step-1-importing-data">Step 1: Importing data<a class="anchor" aria-label="anchor" href="#step-1-importing-data"></a>
</h2>
<p>STbayes minimally needs event data and network data. Let‚Äôs first look
at the event data.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">event_data</span> <span class="op">&lt;-</span> <span class="fu">STbayes</span><span class="fu">::</span><span class="va">event_data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">event_data</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 √ó 4</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Groups:   time [6]</span></span></span>
<span><span class="co">#&gt;      id  time t_end trial</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>    13    35   401     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>    30    37   401     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>    31    48   401     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>    16    63   401     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>    20    67   401     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>    38    69   401     1</span></span></code></pre></div>
<p>Event data gives information about the spreading of the behavior or
information and must contain columns:</p>
<ul>
<li>
<code>id</code>: Character or numeric individual identities.</li>
<li>
<code>trial</code>: Character or numeric column indicating which
trial the event belongs to. There is only one trial in this
data-set.</li>
<li>
<code>time</code>: Integer or float values indicating the time
(TADA) or order (OADA) in which the individual was recorded as first
informed/knowledgable. If an individual had the event occur prior to the
start of the observation period (e.g.¬†pre-trained demonstrator), set as
0. These left censored individuals will not contribute to the likelihood
calculation. If an individual never learned during the observation
period, set its value
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mtext mathvariant="normal">end</mtext></msub><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">t_{\text{end}}+1</annotation></semantics></math>.
These will be treated as right-censored individuals in the likelihood
calculation.</li>
<li>
<code>t_end</code>: Integer or float value representing the duration
of the observation period for each trial. If the user observed a
population for 30 days, <code>t_end=30</code>. If there are no censored
individuals set <code>t_end=max(time)</code>.</li>
</ul>
<p>Next let‚Äôs look at the network data:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">edge_list</span> <span class="op">&lt;-</span> <span class="fu">STbayes</span><span class="fu">::</span><span class="va">edge_list</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">edge_list</span><span class="op">)</span></span>
<span><span class="co">#&gt;   focal other trial assoc</span></span>
<span><span class="co">#&gt; 1     1     4     1     1</span></span>
<span><span class="co">#&gt; 2     1    11     1     1</span></span>
<span><span class="co">#&gt; 3     1    15     1     1</span></span>
<span><span class="co">#&gt; 4     1    17     1     1</span></span>
<span><span class="co">#&gt; 5     2     6     1     1</span></span>
<span><span class="co">#&gt; 6     2     7     1     1</span></span></code></pre></div>
<p>This edge list gives the network connections of each individual in a
long format. You can give a sparse edge list that doesn‚Äôt include all
dyads, but importantly, all individuals must be accounted for in the
edge list. The first three columns must be:</p>
<ul>
<li>
<code>trial</code>: Character or numeric column indicating which
trial the networks belong to.</li>
<li>
<code>focal</code>: Character or numeric column of individual
identities.</li>
<li>
<code>other</code>: Character or numeric column of individual
identities.</li>
</ul>
<p>Any remaining columns are descriptively named integer or float edge
weights. If you were making a multi-network model, you could add as many
columns as you want. Here, there is only one network named
<code>assoc</code>. <strong>Important: for directed networks, the edge
weight describes the influence that <code>other</code> may have on
<code>focal</code> experiencing the target event. For example, if you
wish to model vertical transmission from parent to offspring, this
should contain rows <code>mother, daughter, 0</code>;
<code>daughter, mother, 1</code></strong>. Naming conventions for
identities and trials must be consistent between these two dataframes
(i.e.¬†integers, or matching character strings). The networks dataframe
is used as the reference for all unique IDs, thus each ID must be
included at least once in either the focal or other column. If a dyad is
absent, their connection is assumed to be zero.</p>
<p>Let‚Äôs import the data into a format that can be used with other
STbayes functions. I‚Äôve tried to abstract away as much complexity as
possible, but please check the function arguments before sending in the
data. The default values might not be what you want! In this case, it‚Äôs
simple‚Äîwe have no covariates and a single trial with a static network.
You can specify whether the network is directed or undirected using
<code>network_type</code>. This defaults to undirected.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/import_user_STb.html">import_user_STb</a></span><span class="op">(</span>event_data <span class="op">=</span> <span class="va">event_data</span>, </span>
<span>                             networks <span class="op">=</span> <span class="va">edge_list</span>,</span>
<span>                             network_type <span class="op">=</span> <span class="st">"undirected"</span><span class="op">)</span></span>
<span><span class="co">#&gt; User supplied edge weights as point estimates üìç</span></span>
<span><span class="co">#&gt; No ILV supplied.</span></span>
<span><span class="co">#&gt; User input indicates static network(s). If dynamic, include 'time' column.</span></span>
<span><span class="co">#&gt; ‚ñë‚ñí‚ñì‚ñà‚ñ∫‚îÄ‚ïê Sanity check ‚ïê‚îÄ‚óÑ‚ñà‚ñì‚ñí‚ñë</span></span>
<span><span class="co">#&gt; User provided data about:</span></span>
<span><span class="co">#&gt; 50 individuals across 1 independent diffusions (trials).</span></span>
<span><span class="co">#&gt; There were 50 individuals in each trial.</span></span>
<span><span class="co">#&gt; User supplied 1 networks: assoc</span></span>
<span><span class="co">#&gt; ILV for asocial learning: ILVabsent</span></span>
<span><span class="co">#&gt; ILV for social learning: ILVabsent</span></span>
<span><span class="co">#&gt; multiplicative model ILV: ILVabsent</span></span>
<span><span class="co">#&gt; ü§î Does that seem right to you?</span></span></code></pre></div>
<p>This function does quite a bit behind the scenes to process the raw
observational data into a named list of variables. I‚Äôve tried to
optimize as much as possible so it shouldn‚Äôt take more than a second or
two unless you‚Äôre using gigantic networks. Important bits include:</p>
<ol style="list-style-type: decimal">
<li>
<em>Validates and standardizes inputs.</em> The function confirms
that necessary columns are present, and maps individual and trial
identifiers across data frames. The IDs present in the network data are
used as the reference for any other data that you supply. For example,
if an ID is in the edge list, but not in the event data, it will be
automatically added as a censored individual into the event_data. We
strongly suggest accounting for all individuals in all data provided to
this function to avoid any surprises later on in the analysis.</li>
<li>
<em>Preprocesses event data.</em> The function sorts events by time
within each trial and assigns a discrete time index that is used to
refer to inter-event intervals. E.g. <code>timestep=1</code> corresponds
to the start of the observation period until the first event. If
<code>high-res</code> mode is used, all durations are set to 1. It also
calculates the duration of each of these inter-event intervals. It
identifies demonstrators (<code>time==0</code>) and right censored
individuals (<code>time&gt;t_end</code>).</li>
<li>
<em>Preprocesses network data.</em> If static, a single matrix is
used for all times. If dynamic, it aligns edge weights across trials and
inter-event intervals. If high resolution, it will collapse data into
inter-event intervals, multiplying edge weights by transmission weights
and then dividing by duration. When fitting, this term will be
multiplied out again by duration, so for linear transmission, this is
equivalent to running the likelihood in Stan for every single time-step
and greatly speeds up model fitting. We note that this pre-processing is
not possible complex transmission models.</li>
<li>
<em>Preprocesses covariates.</em> The function recognizes and stores
the roles of ILVs as affecting (or not) the intrinsic rate, the social
rate or both rates (multiplicative).</li>
</ol>
</div>
<div class="section level2">
<h2 id="step-2-generate-a-model">Step 2: Generate a model<a class="anchor" aria-label="anchor" href="#step-2-generate-a-model"></a>
</h2>
<p>Next, we can pass this into a function that automatically creates
Stan code that is customised to your data and modelling desires. Each
time you generate a model, the function will display the default priors
it‚Äôll use. You can specify your own priors using the argument
<code>priors</code> and give it a named list.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_full</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_STb_model.html">generate_STb_model</a></span><span class="op">(</span><span class="va">data_list</span>, gq <span class="op">=</span> <span class="cn">T</span>, est_acqTime <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="co">#&gt; Creating cTADA type model with the following default priors:</span></span>
<span><span class="co">#&gt; log_lambda0 ~ normal(-4, 2)</span></span>
<span><span class="co">#&gt; log_sprime ~ normal(-4, 2)</span></span>
<span><span class="co">#&gt; beta_ILV ~ normal(0,1)</span></span>
<span><span class="co">#&gt; log_f ~ normal(0,1)</span></span>
<span><span class="co">#&gt; k_raw ~ normal(0,3)</span></span>
<span><span class="co">#&gt; z_ID ~ normal(0,1)</span></span>
<span><span class="co">#&gt; sigma_ID ~ normal(0,1)</span></span>
<span><span class="co">#&gt; rho_ID ~ lkj_corr_cholesky(3)</span></span>
<span><span class="co">#&gt; gamma ~ normal(0,1)</span></span></code></pre></div>
<p>This returns a very long string containing the code. The argument
<code>gq</code> indicates whether a generated quantities block will be
created. This defaults to TRUE, as it‚Äôs needed to output the
log-likelihood of observations for any kind of model comparison later.
The <code>est_acqTime</code> argument tells STbayes to automatically
generate some code to return a posterior distribution of estimated times
of events for each individual.</p>
<p>To quickly check the model code in R, just use <code><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat()</a></code>.
Otherwise, I recommend saving it, as the formatting might need a bit of
cleaning before it‚Äôs readable:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/write.html" class="external-link">write</a></span><span class="op">(</span><span class="va">model_full</span>, file<span class="op">=</span><span class="st">"../data/stan_models/my_first_model.stan"</span><span class="op">)</span></span></code></pre></div>
<p>If you want to directly modify the code, go ahead. You can supply the
file path of the model rather than <code>model_obj</code> in the next
call to <code><a href="../reference/fit_STb.html">fit_STb()</a></code>. Here, we‚Äôll just use the model stored in
the variable.</p>
<div class="section level3">
<h3 id="function-arguments">Function arguments<a class="anchor" aria-label="anchor" href="#function-arguments"></a>
</h3>
<p>Here is a summary of each argument to <code>generate_STb_model</code>
for easy reference:</p>
<ul>
<li>
<code>data_type=c("continuous_time", "discrete_time", "order")</code>
distinguishes between cases where the times of events are known (TADA
type models) or only the order of events is known (OADA type models). If
exact times of acquisition are known the user can select
<code>"continuous_time"</code>, creating a cTADA model. If a population
was regularly (or irregularly) sampled, so the exact time of events are
unknown but the rough interval they occurred in is known, the user
should select <code>"discrete_time"</code>, which creates a dTADA
model.</li>
<li>
<code>veff_ID=c("lambda_0", "s", ...),</code> is used to specify
which variables should receive varying effects by individual. For
example, <code>veff_ID=c("lambda_0", "s")</code> will create a model
that will attempt to fit varying effects for both intrinsic rate and
strength of social transmission. It is possible to include other ILVs,
if desired.</li>
<li>
<code>model_type=c("full","asocial")</code> specifies whether to
create a full model or an asocial model constrained to the intrinsic
rate only</li>
<li>
<code>intrinsic_rate=c("constant", "weibull")</code> specifies
whether or not the user wishes to use a constant intrinsic rate, or a
Weibull shaped rate that can increase or decrease over time. This fits
an additional parameter
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Œ≥</mi><annotation encoding="application/x-tex">\gamma</annotation></semantics></math>,
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Œ≥</mi><mo>&lt;</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\gamma&lt;1</annotation></semantics></math>
indicates a decreasing hazard over time, and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Œ≥</mi><mo>&gt;</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\gamma&gt;1</annotation></semantics></math>
indicates an increasing hazard over time.
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Œ≥</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\gamma=1</annotation></semantics></math>
indicates a constant hazard.</li>
<li>
<code>transmission_func=c("standard","freqdep_f", "freqdep_k")</code>
specifies whether the model uses simple or complex transmission.</li>
<li>
<code>gq</code> specifies whether or not a generated quantities
block is created in the Stan model. This defaults to true, as the
log-likelihood of observations is output using generated quantities and
is needed for model comparison.</li>
<li>
<code>est_acqTime</code> specifies whether estimated acquisition
times are also output by the generated quantities block. These are
useful for posterior predictive checks, but this argument defaults to
false for efficiency in fitting.</li>
<li>
<code>priors</code> allows users to specify priors for parameters in
the format of a named list. Please see the advanced recipes vignette for
more details</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="step-3-fit-and-save-the-model">Step 3: Fit and save the model<a class="anchor" aria-label="anchor" href="#step-3-fit-and-save-the-model"></a>
</h2>
<p>We supply the data_list and model_obj for fitting the model:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">full_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_STb.html">fit_STb</a></span><span class="op">(</span><span class="va">data_list</span>,</span>
<span>    <span class="va">model_full</span>,</span>
<span>    parallel_chains <span class="op">=</span> <span class="fl">4</span>,</span>
<span>    chains <span class="op">=</span> <span class="fl">4</span>,</span>
<span>    cores <span class="op">=</span> <span class="fl">4</span>,</span>
<span>    iter <span class="op">=</span> <span class="fl">4000</span>,</span>
<span>    refresh<span class="op">=</span><span class="fl">1000</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Detected N_veff = 0</span></span>
<span><span class="co">#&gt; ‚è≥ Sampling...</span></span>
<span><span class="co">#&gt; Running MCMC with 4 parallel chains...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Chain 1 Iteration:    1 / 4000 [  0%]  (Warmup) </span></span>
<span><span class="co">#&gt; Chain 2 Iteration:    1 / 4000 [  0%]  (Warmup) </span></span>
<span><span class="co">#&gt; Chain 3 Iteration:    1 / 4000 [  0%]  (Warmup) </span></span>
<span><span class="co">#&gt; Chain 4 Iteration:    1 / 4000 [  0%]  (Warmup) </span></span>
<span><span class="co">#&gt; Chain 2 Iteration: 1000 / 4000 [ 25%]  (Warmup) </span></span>
<span><span class="co">#&gt; Chain 1 Iteration: 1000 / 4000 [ 25%]  (Warmup) </span></span>
<span><span class="co">#&gt; Chain 3 Iteration: 1000 / 4000 [ 25%]  (Warmup) </span></span>
<span><span class="co">#&gt; Chain 4 Iteration: 1000 / 4000 [ 25%]  (Warmup) </span></span>
<span><span class="co">#&gt; Chain 2 Iteration: 2000 / 4000 [ 50%]  (Warmup) </span></span>
<span><span class="co">#&gt; Chain 2 Iteration: 2001 / 4000 [ 50%]  (Sampling) </span></span>
<span><span class="co">#&gt; Chain 4 Iteration: 2000 / 4000 [ 50%]  (Warmup) </span></span>
<span><span class="co">#&gt; Chain 4 Iteration: 2001 / 4000 [ 50%]  (Sampling) </span></span>
<span><span class="co">#&gt; Chain 1 Iteration: 2000 / 4000 [ 50%]  (Warmup) </span></span>
<span><span class="co">#&gt; Chain 1 Iteration: 2001 / 4000 [ 50%]  (Sampling) </span></span>
<span><span class="co">#&gt; Chain 3 Iteration: 2000 / 4000 [ 50%]  (Warmup) </span></span>
<span><span class="co">#&gt; Chain 3 Iteration: 2001 / 4000 [ 50%]  (Sampling) </span></span>
<span><span class="co">#&gt; Chain 1 Iteration: 3000 / 4000 [ 75%]  (Sampling) </span></span>
<span><span class="co">#&gt; Chain 4 Iteration: 3000 / 4000 [ 75%]  (Sampling) </span></span>
<span><span class="co">#&gt; Chain 3 Iteration: 3000 / 4000 [ 75%]  (Sampling) </span></span>
<span><span class="co">#&gt; Chain 2 Iteration: 3000 / 4000 [ 75%]  (Sampling) </span></span>
<span><span class="co">#&gt; Chain 1 Iteration: 4000 / 4000 [100%]  (Sampling) </span></span>
<span><span class="co">#&gt; Chain 1 finished in 18.3 seconds.</span></span>
<span><span class="co">#&gt; Chain 3 Iteration: 4000 / 4000 [100%]  (Sampling) </span></span>
<span><span class="co">#&gt; Chain 4 Iteration: 4000 / 4000 [100%]  (Sampling) </span></span>
<span><span class="co">#&gt; Chain 3 finished in 19.1 seconds.</span></span>
<span><span class="co">#&gt; Chain 4 finished in 19.1 seconds.</span></span>
<span><span class="co">#&gt; Chain 2 Iteration: 4000 / 4000 [100%]  (Sampling) </span></span>
<span><span class="co">#&gt; Chain 2 finished in 19.6 seconds.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; All 4 chains finished successfully.</span></span>
<span><span class="co">#&gt; Mean chain execution time: 19.0 seconds.</span></span>
<span><span class="co">#&gt; Total execution time: 19.9 seconds.</span></span>
<span><span class="co">#&gt; ü´¥ Use STb_save() to save the fit and chain csvs to a single RDS file. Or don't!</span></span></code></pre></div>
<p>This function calls cmdstanr‚Äôs $sample(), and you can add any extra
valid arguments to pass on here. In this call, I‚Äôve made sure that we
run 4 chains in parallel for 4000 iterations, and only to update us on
progress every 1000 iterations. By default, fit_STb() will do iter/2
worth of warmup, and iter/2 worth of sampling. Fitting can take anywhere
from seconds to hours depending on your computer and the amount of data.
Fitting this dataset <em>should</em> be quick. If it‚Äôs very slow, you
might want to try running this on your friend‚Äôs computer. I‚Äôve tried to
make things reasonably efficient, but have not parallelized the model
block yet.</p>
<p>I strongly recommend using the convenience function below to save the
output after fitting. If you only save the fit object to an rda using
something like <code><a href="https://rdrr.io/r/base/save.html" class="external-link">save()</a></code>, it will not include the data output
from chains, making it useless. <code>STb_save</code> saves these
alongside the fit in a single file:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/STb_save.html">STb_save</a></span><span class="op">(</span><span class="va">full_fit</span>, output_dir <span class="op">=</span> <span class="st">"cmdstan_saves"</span>, name<span class="op">=</span><span class="st">"my_first_fit"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Fit &amp; chains successfully saved üíæ </span></span>
<span><span class="co">#&gt; You can load fit again with üëâ readRDS('cmdstan_saves/my_first_fit.rds') </span></span></code></pre></div>
<p>If you don‚Äôt provide a name, it will use the name of the object.</p>
</div>
<div class="section level2">
<h2 id="step-4-viewing-model-output">Step 4: Viewing model output<a class="anchor" aria-label="anchor" href="#step-4-viewing-model-output"></a>
</h2>
<p>We can inspect the parameter estimates using the convenience function
below:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/STb_summary.html">STb_summary</a></span><span class="op">(</span><span class="va">full_fit</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt;           Parameter Median   MAD CI_Lower CI_Upper ess_bulk ess_tail  Rhat</span></span>
<span><span class="co">#&gt; 1 log_lambda_0_mean -6.871 0.453   -7.798   -6.007 4289.196 4170.766 1.000</span></span>
<span><span class="co">#&gt; 2  log_s_prime_mean -5.372 0.173   -5.728   -5.033 4222.179 4073.156 1.001</span></span>
<span><span class="co">#&gt; 3          lambda_0  0.001 0.000    0.000    0.002 4289.223 4170.766 1.000</span></span>
<span><span class="co">#&gt; 4                 s  4.536 2.386    1.280   12.016 3745.039 4147.067 1.001</span></span>
<span><span class="co">#&gt; 5     percent_ST[1]  0.818 0.047    0.712    0.892 3745.049 4147.067 1.001</span></span></code></pre></div>
<p>The most important output are the intrinsic rate (lambda_0), and the
relative strength of social transmission (s), whose interpretations are
the same as the NBDA package. The relative strength of social
transmission (s = s_prime / lambda_0) is generally what we‚Äôre after. %ST
for network
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>n</mi><annotation encoding="application/x-tex">n</annotation></semantics></math>
is reported as <code>percent_ST[n]</code>. This is a single-network
model, thus <code>percent_ST[1]</code> is the estimated percentage of
events that occurred through social transmission. The [1] refers to the
‚Äúassoc‚Äù network, as we‚Äôve only given a single network. If you fit a
multi-network model, all networks will have an estimate. For a number of
reasons, STbayes actually fits lambda_0 and social transmission rate
(s_prime) on the log scale. The linear transformation of s_prime itself
usually isn‚Äôt reported and is excluded from the output, but you could
calculate it yourself from the fit.</p>
<p>At this point, you are just dealing with a cmdstanr fit, so if you
have your own pipeline, adios! However, I have provided a few more
useful functions for posterior predictive checks and model
comparison.</p>
</div>
<div class="section level2">
<h2 id="step-5-posterior-predictive-checks">Step 5: Posterior predictive checks<a class="anchor" aria-label="anchor" href="#step-5-posterior-predictive-checks"></a>
</h2>
<p>STbayes makes it relatively painless to perform posterior predictive
checks (PPC) without having to manually simulate data after the fitting
process. PPC are important to assess whether or not the model reproduces
features of the observed data and make sure that your likelihood
reasonably matches the data-generating process.</p>
<p>Above, we used the argument <code>est_acqTime=T</code>. As the Stan
model runs, in each iteration it will generate an estimated event time
based on the parameter values for that iteration. With this, we can make
two types of PPC.</p>
<div class="section level3">
<h3 id="cumulative-diffusion-curves">Cumulative diffusion curves<a class="anchor" aria-label="anchor" href="#cumulative-diffusion-curves"></a>
</h3>
<p>We can plot the posterior distribution of cumulative diffusion curves
and compare them with the observed curve. First, we create a dataframe
for the cumulative number of individuals who experienced an event.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_data_obs</span> <span class="op">&lt;-</span> <span class="va">event_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="va">time</span> <span class="op">&lt;=</span> <span class="va">t_end</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co"># exclude demonstrators (time == 0) and censored (time &gt; t_end)</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">trial</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">time</span>, .by_group <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>        cum_prop <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        type <span class="op">=</span> <span class="st">"observed"</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">trial</span>, <span class="va">time</span>, <span class="va">cum_prop</span>, <span class="va">type</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># add in 0,0 starting point</span></span>
<span><span class="va">plot_data_obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>    <span class="va">plot_data_obs</span>,</span>
<span>    <span class="va">plot_data_obs</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">trial</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fl">0</span>, cum_prop <span class="op">=</span> <span class="fl">0</span>, type <span class="op">=</span> <span class="st">"observed"</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">trial</span>, <span class="va">time</span><span class="op">)</span></span></code></pre></div>
<p>Next, we can extract the draws of estimated acquisition times,
excluding warm-up iterations, as a data-frame. We can then pivot it into
a long format and calculate the cumulative curves for each draw as we
did our observed data. Note that I thinned the draws for the sake of
visualization.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">draws_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/posterior/reference/draws_df.html" class="external-link">as_draws_df</a></span><span class="op">(</span><span class="va">full_fit</span><span class="op">$</span><span class="fu">draws</span><span class="op">(</span>variables <span class="op">=</span> <span class="st">"acquisition_time"</span>, inc_warmup <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># pivot longer</span></span>
<span><span class="va">ppc_long</span> <span class="op">&lt;-</span> <span class="va">draws_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"acquisition_time["</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>        cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html" class="external-link">everything</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        names_to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"trial"</span>, <span class="st">"ind"</span><span class="op">)</span>,</span>
<span>        names_pattern <span class="op">=</span> <span class="st">"acquisition_time\\[(\\d+),(\\d+)\\]"</span>,</span>
<span>        values_to <span class="op">=</span> <span class="st">"time"</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>        trial <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">trial</span><span class="op">)</span>,</span>
<span>        ind <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">ind</span><span class="op">)</span>,</span>
<span>        draw <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">draws_df</span><span class="op">)</span><span class="op">)</span>, each <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">trial</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">ind</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Dropping 'draws_df' class as required metadata was removed.</span></span>
<span></span>
<span><span class="co"># thin sample for plotting</span></span>
<span><span class="va">sample_idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">ppc_long</span><span class="op">$</span><span class="va">draw</span><span class="op">)</span><span class="op">)</span>, <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">ppc_long</span> <span class="op">&lt;-</span> <span class="va">ppc_long</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">draw</span> <span class="op"><a href="https://mc-stan.org/posterior/reference/match.html" class="external-link">%in%</a></span> <span class="va">sample_idx</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># build cumulative curves per draw</span></span>
<span><span class="va">plot_data_ppc</span> <span class="op">&lt;-</span> <span class="va">ppc_long</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">draw</span>, <span class="va">trial</span>, <span class="va">time</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">draw</span>, <span class="va">trial</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>cum_prop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">/</span> <span class="va">data_list</span><span class="op">$</span><span class="va">Q</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># add in 0,0 starting point</span></span>
<span><span class="va">plot_data_ppc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>    <span class="va">plot_data_ppc</span>,</span>
<span>    <span class="va">plot_data_ppc</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">trial</span>, <span class="va">draw</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fl">0</span>, cum_prop <span class="op">=</span> <span class="fl">0</span>, type <span class="op">=</span> <span class="st">"ppc"</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">trial</span>, <span class="va">time</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot it</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">plot_data_ppc</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">cum_prop</span>, group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/interaction.html" class="external-link">interaction</a></span><span class="op">(</span><span class="va">draw</span>, <span class="va">trial</span><span class="op">)</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">plot_data_obs</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">cum_prop</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Time"</span>, y <span class="op">=</span> <span class="st">"Cumulative proportion informed"</span>, color <span class="op">=</span> <span class="st">"Trial"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="getting_started_files/figure-html/PPC2-1.png" width="700"></p>
<p>This looks pretty good, the observed curve falls within the variation
of the posterior draws. If the observed data fell outside of the draws,
you might want to rethink the model specification, whether any
influential variables have been excluded, and whether there might be
complex transmission processes.</p>
</div>
<div class="section level3">
<h3 id="estimated-vs--observed-acquisition-times">Estimated vs.¬†observed acquisition times<a class="anchor" aria-label="anchor" href="#estimated-vs--observed-acquisition-times"></a>
</h3>
<p>For each individual, you could also compare the estimated versus
observed event times. STbayes‚Äô function <code>extract_acqTime</code>
conveniently extracts the times for each individual and re-aligns them
with their identities.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">acqdata</span> <span class="op">=</span> <span class="fu"><a href="../reference/extract_acqTime.html">extract_acqTime</a></span><span class="op">(</span><span class="va">full_fit</span>, <span class="va">data_list</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">acqdata</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">observed_time</span>, y <span class="op">=</span> <span class="va">median_time</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html" class="external-link">geom_segment</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">observed_time</span>, xend <span class="op">=</span> <span class="va">observed_time</span>, y <span class="op">=</span> <span class="va">median_time</span>, yend <span class="op">=</span> <span class="va">observed_time</span><span class="op">)</span>,</span>
<span>        color <span class="op">=</span> <span class="st">"red"</span>,</span>
<span>        alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept <span class="op">=</span> <span class="fl">0</span>, slope <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="st">"black"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Observed time"</span>, y <span class="op">=</span> <span class="st">"Estimated time"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="getting_started_files/figure-html/PPC3-1.png" width="700"></p>
<p>Due to stochastic variation in orders of acquisition between draws,
the cumulative curve approach is probably more useful as a PPC.</p>
</div>
</div>
<div class="section level2">
<h2 id="step-6-model-comparison">Step 6: Model comparison<a class="anchor" aria-label="anchor" href="#step-6-model-comparison"></a>
</h2>
<p>Often, you‚Äôll want to make sure that a model with social transmission
is more predictive than a model that excludes it. First, let‚Äôs refit
using a constrained model that only includes an intrinsic rate by using
the argument <code>model_type="asocial"</code> when generating a model.
For a fair comparison, make sure the chains and iterations are identical
to the full model fit.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_asoc</span> <span class="op">=</span> <span class="fu"><a href="../reference/generate_STb_model.html">generate_STb_model</a></span><span class="op">(</span><span class="va">data_list</span>, model_type<span class="op">=</span><span class="st">"asocial"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Creating cTADA type model with the following default priors:</span></span>
<span><span class="co">#&gt; log_lambda0 ~ normal(-4, 2)</span></span>
<span><span class="co">#&gt; log_sprime ~ normal(-4, 2)</span></span>
<span><span class="co">#&gt; beta_ILV ~ normal(0,1)</span></span>
<span><span class="co">#&gt; log_f ~ normal(0,1)</span></span>
<span><span class="co">#&gt; k_raw ~ normal(0,3)</span></span>
<span><span class="co">#&gt; z_ID ~ normal(0,1)</span></span>
<span><span class="co">#&gt; sigma_ID ~ normal(0,1)</span></span>
<span><span class="co">#&gt; rho_ID ~ lkj_corr_cholesky(3)</span></span>
<span><span class="co">#&gt; gamma ~ normal(0,1)</span></span>
<span><span class="va">asocial_fit</span> <span class="op">=</span> <span class="fu"><a href="../reference/fit_STb.html">fit_STb</a></span><span class="op">(</span><span class="va">data_list</span>,</span>
<span>                      <span class="va">model_asoc</span>,</span>
<span>                      parallel_chains <span class="op">=</span> <span class="fl">4</span>,</span>
<span>                      chains <span class="op">=</span> <span class="fl">4</span>,</span>
<span>                      cores <span class="op">=</span> <span class="fl">4</span>,</span>
<span>                      iter <span class="op">=</span> <span class="fl">4000</span>,</span>
<span>                      refresh<span class="op">=</span><span class="fl">1000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Detected N_veff = 0</span></span>
<span><span class="co">#&gt; ‚è≥ Sampling...</span></span>
<span><span class="co">#&gt; Running MCMC with 4 parallel chains...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Chain 1 Iteration:    1 / 4000 [  0%]  (Warmup) </span></span>
<span><span class="co">#&gt; Chain 1 Iteration: 1000 / 4000 [ 25%]  (Warmup) </span></span>
<span><span class="co">#&gt; Chain 2 Iteration:    1 / 4000 [  0%]  (Warmup) </span></span>
<span><span class="co">#&gt; Chain 2 Iteration: 1000 / 4000 [ 25%]  (Warmup) </span></span>
<span><span class="co">#&gt; Chain 3 Iteration:    1 / 4000 [  0%]  (Warmup) </span></span>
<span><span class="co">#&gt; Chain 3 Iteration: 1000 / 4000 [ 25%]  (Warmup) </span></span>
<span><span class="co">#&gt; Chain 4 Iteration:    1 / 4000 [  0%]  (Warmup) </span></span>
<span><span class="co">#&gt; Chain 1 Iteration: 2000 / 4000 [ 50%]  (Warmup) </span></span>
<span><span class="co">#&gt; Chain 1 Iteration: 2001 / 4000 [ 50%]  (Sampling) </span></span>
<span><span class="co">#&gt; Chain 2 Iteration: 2000 / 4000 [ 50%]  (Warmup) </span></span>
<span><span class="co">#&gt; Chain 2 Iteration: 2001 / 4000 [ 50%]  (Sampling) </span></span>
<span><span class="co">#&gt; Chain 3 Iteration: 2000 / 4000 [ 50%]  (Warmup) </span></span>
<span><span class="co">#&gt; Chain 3 Iteration: 2001 / 4000 [ 50%]  (Sampling) </span></span>
<span><span class="co">#&gt; Chain 4 Iteration: 1000 / 4000 [ 25%]  (Warmup) </span></span>
<span><span class="co">#&gt; Chain 1 Iteration: 3000 / 4000 [ 75%]  (Sampling) </span></span>
<span><span class="co">#&gt; Chain 2 Iteration: 3000 / 4000 [ 75%]  (Sampling) </span></span>
<span><span class="co">#&gt; Chain 4 Iteration: 2000 / 4000 [ 50%]  (Warmup) </span></span>
<span><span class="co">#&gt; Chain 4 Iteration: 2001 / 4000 [ 50%]  (Sampling) </span></span>
<span><span class="co">#&gt; Chain 3 Iteration: 3000 / 4000 [ 75%]  (Sampling) </span></span>
<span><span class="co">#&gt; Chain 4 Iteration: 3000 / 4000 [ 75%]  (Sampling) </span></span>
<span><span class="co">#&gt; Chain 1 Iteration: 4000 / 4000 [100%]  (Sampling) </span></span>
<span><span class="co">#&gt; Chain 2 Iteration: 4000 / 4000 [100%]  (Sampling) </span></span>
<span><span class="co">#&gt; Chain 3 Iteration: 4000 / 4000 [100%]  (Sampling) </span></span>
<span><span class="co">#&gt; Chain 4 Iteration: 4000 / 4000 [100%]  (Sampling) </span></span>
<span><span class="co">#&gt; Chain 1 finished in 0.5 seconds.</span></span>
<span><span class="co">#&gt; Chain 2 finished in 0.4 seconds.</span></span>
<span><span class="co">#&gt; Chain 3 finished in 0.5 seconds.</span></span>
<span><span class="co">#&gt; Chain 4 finished in 0.5 seconds.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; All 4 chains finished successfully.</span></span>
<span><span class="co">#&gt; Mean chain execution time: 0.5 seconds.</span></span>
<span><span class="co">#&gt; Total execution time: 0.6 seconds.</span></span>
<span><span class="co">#&gt; ü´¥ Use STb_save() to save the fit and chain csvs to a single RDS file. Or don't!</span></span></code></pre></div>
<p>If you are familiar with loo or have your own pipeline, then you can
use that to compare these models. STbayes provides a convenient function
for performing model comparison. You can provide as many models as you
want, here we just compare these two.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">loo_output</span> <span class="op">=</span> <span class="fu"><a href="../reference/STb_compare.html">STb_compare</a></span><span class="op">(</span><span class="va">full_fit</span>, <span class="va">asocial_fit</span>, method<span class="op">=</span><span class="st">"loo-psis"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Calculating LOO-PSIS.</span></span>
<span><span class="co">#&gt; Comparing models.</span></span>
<span><span class="co">#&gt; Calculating pareto-k diagnostic (only for loo-psis).</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">loo_output</span><span class="op">$</span><span class="va">comparison</span>, simplify <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt;             elpd_diff se_diff elpd_loo se_elpd_loo p_loo  se_p_loo looic </span></span>
<span><span class="co">#&gt; full_fit       0.0       0.0  -290.7      6.2         2.0    0.5    581.5</span></span>
<span><span class="co">#&gt; asocial_fit  -21.3       5.3  -312.0      3.9         0.3    0.0    624.1</span></span>
<span><span class="co">#&gt;             se_looic</span></span>
<span><span class="co">#&gt; full_fit      12.4  </span></span>
<span><span class="co">#&gt; asocial_fit    7.7</span></span></code></pre></div>
<p>If you are not familiar with leave-out-out cross validation, I
strongly suggest reading up on it, but the TLDR is that you should pay
attention to the elpd_diff and se_diff columns. A model is credibly more
predictive if the standard error in differences of ELPD does not cross
0. Here, -21.2 + 5.3 &lt; 0, so we can conclude the full model is more
predictive of out-of-sample data than an asocial only model. If you
would rather see this graphically:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">comparison_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">loo_output</span><span class="op">$</span><span class="va">comparison</span><span class="op">)</span></span>
<span><span class="va">comparison_df</span><span class="op">$</span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">comparison_df</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">comparison_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html" class="external-link">reorder</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">elpd_diff</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">elpd_diff</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span> <span class="co">#elpd_diff</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_errorbar</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">elpd_diff</span> <span class="op">-</span> <span class="va">se_diff</span>, </span>
<span>                      ymax <span class="op">=</span> <span class="va">elpd_diff</span> <span class="op">+</span> <span class="va">se_diff</span><span class="op">)</span>, width <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span> <span class="co">#SE of elpd diff</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html" class="external-link">coord_flip</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Model"</span>, y <span class="op">=</span> <span class="st">"ELPD Difference"</span>, title <span class="op">=</span> <span class="st">"Model Comparison"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="getting_started_files/figure-html/model_comparison3-1.png" width="700"></p>
<p>PSIS-LOO is an approximation of LOO, and observations with pareto-k
diagnostic values &gt;.7 may indicate that the approximation is
unreliable. The function above will warn you if that is the case, and
you can visually inspect these diagnostics like so:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pareto_df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">loo_output</span><span class="op">$</span><span class="va">pareto_diagnostics</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">pareto_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">observation</span>, y<span class="op">=</span><span class="va">pareto_k</span>, color<span class="op">=</span><span class="va">model</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_d</a></span><span class="op">(</span>begin<span class="op">=</span><span class="fl">0.2</span>, end<span class="op">=</span><span class="fl">0.7</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0.7</span>, linetype<span class="op">=</span><span class="st">"dashed"</span>, color<span class="op">=</span><span class="st">"orange"</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">1</span>, linetype<span class="op">=</span><span class="st">"dashed"</span>, color<span class="op">=</span><span class="st">"red"</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"Observation"</span>, y<span class="op">=</span><span class="st">"Pareto-k value"</span>, title<span class="op">=</span><span class="st">"Pareto-k diagnostics"</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="getting_started_files/figure-html/model_comparison4-1.png" width="700"></p>
<p>All of the pareto-k values are below the danger zone.</p>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>These are the basics of using STbayes. You only need event data and
network data for a minimal model. However, the package is flexible and
you can make use of many other types of data and formulations. Please
see the ‚ÄúAdvanced recipes‚Äù vignette for demonstrations of multi-network
models, dynamic network models, and models with ILVs, transmission
weights, varying effects, complex transmission, and marginalizing over
edge-weight uncertainty.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Michael Chimento.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
